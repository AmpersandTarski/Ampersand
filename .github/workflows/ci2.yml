# Inspired by https://tech.freckle.com/2021/05/18/haskell-on-actions/
name: Build and test 游
on:
  push:
    branches:
      - "**" # Only trigger on branches (i.e. not tags, ..)

jobs:
  hlint:
    name: Check for code sanity with hlint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project contents 游니
        uses: actions/checkout@v2
      - name: Setup hlint
        uses: rwe/actions-hlint-setup@v1
      - name: Run hlint
        uses: rwe/actions-hlint-run@v2

  build-and-test-docker:
    name: Build with Docker
    runs-on: ubuntu-latest
    env:
      DOCKER_AMPERSAND_IMAGE: ampersandtarski/ampersand
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Prepare for docker
        run: |
          echo Running on branch ${GITHUB_REF##*/}
          docker version

      - name: Build final image
        run: docker build . --tag ${DOCKER_AMPERSAND_IMAGE}:latest --build-arg GIT_SHA=${{ github.sha }} --build-arg GIT_Branch=${{ github.ref }}

      # For main branch push latest to DockerHub
      - name: Login to DockerHub
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - name: Push latest
        if: github.ref == 'refs/heads/main'
        run: docker push ${DOCKER_AMPERSAND_IMAGE}:latest

  build-and-test-ubuntu:
    name: Build and test on ubuntu-latest 游끵 游빍
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project contents 游니
        uses: actions/checkout@v2
      - name: Use cache when available 游닍
        uses: freckle/stack-cache-action@main
      - name: Set up Mariadb 游빓
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: "mariadb-10.6"
      - name: Build and test 游끵 游빍
        uses: freckle/stack-action@v3 # stack-action does all these steps: dependencies, build, test.
        with:
          stack-arguments: "--copy-bins --flag ampersand:buildAll"
      # Weeder needs compilation artifacts, so it must still be the same Job
      - name: Check weeds游游游
      - uses: freckle/weeder-action@v1

  build-and-test-macOS:
    name: Build and test on macOS  游끵 游빍
    runs-on: macos-latest
    steps:
      - name: Checkout project contents 游니
        uses: actions/checkout@v2
      - name: Use cache when available 游닍
        uses: freckle/stack-cache-action@main
      - name: Set up Mariadb 游빓
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: "mariadb-10.6"
      - name: Build and test  游끵 游빍
        uses: freckle/stack-action@v3
        with:
          stack-arguments: "--copy-bins --flag ampersand:buildAll"
      - name: Check weeds游游游
        uses: freckle/weeder-action@v1

  build-and-test-windows:
    name: Build and test on Windows 游끵 游빍
    runs-on: windows-latest
    steps:
      - name: Checkout project contents 游니
        uses: actions/checkout@v2
      - name: Use cache (manually) 游닍 # See https://github.com/freckle/stack-cache-action/issues/5
        uses: actions/cache@v2.1.3
        # TODO: Cache might be done better, see for inspiration:  https://github.com/godu/advent-of-code-2020/blob/46796832f59d185457a8edf8de043a54a451d688/.github/workflows/ci.yml
        with:
          path: |
            ~/.ghc
            ~/.stack
            ~/.stack-work
          key: ${{ runner.os }}-stack
      - name: Set up Mariadb 游빓
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: "mariadb-10.6"
      - name: Setup PHP 游빓
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          extensions: mysqli
      - name: Build and test 游끵 游빍
        uses: freckle/stack-action@v3
        with:
          stack-arguments: "--copy-bins --flag ampersand:buildAll"
      - name: Check weeds游游游
        uses: freckle/weeder-action@v1
