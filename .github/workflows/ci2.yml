# Inspired by https://tech.freckle.com/2021/05/18/haskell-on-actions/
name: Build and test 🚀
on:
  push:
    branches:
      - "**" # Only trigger on branches (i.e. not tags, ..)

jobs:
  build-and-test-docker:
    name: Build with Docker
    runs-on: ubuntu-latest
    env:
      DOCKER_AMPERSAND_IMAGE: ampersandtarski/ampersand
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Prepare for docker
      run: |
        echo Running on branch ${GITHUB_REF##*/}
        docker version

    - name: Build final image
      run: docker build . --tag ${DOCKER_AMPERSAND_IMAGE}:latest --build-arg GIT_SHA=${{ github.sha }} --build-arg GIT_Branch=${{ github.ref }}

  build-and-test-ubuntu:
    name: Build and test on ubuntu-latest 🏗 🧪
    runs-on: ubuntu-latest
    steps:
      - 
        name: Checkout project contents 📡
        uses: actions/checkout@v2
      - 
        name: Use cache when available 📦
        uses: freckle/stack-cache-action@main
      - 
        name: Build and test 🏗 🧪
        uses: freckle/stack-action@main # stack-action does all these steps: dependencies, build, test.
        with:
          stack-arguments: '--copy-bins --flag ampersand:buildAll'
          weeder: false  # TODO: Re-enable. See https://github.com/AmpersandTarski/Ampersand/issues/1225
          hlint: true

  build-and-test-macOS:
    name: Build and test on macOS  🏗 🧪
    runs-on: macos-latest
    steps:
      - 
        name: Checkout project contents 📡
        uses: actions/checkout@v2
      - 
        name: Use cache when available 📦
        uses: freckle/stack-cache-action@main
      - 
        name: Build and test  🏗 🧪
        uses: freckle/stack-action@main
        with:
          stack-arguments: '--copy-bins --flag ampersand:buildAll'
          weeder: false
          hlint: true

  build-and-test-windows:
    name: Build and test on Windows 🏗 🧪
    runs-on: windows-latest
    steps:
      - 
        name: Checkout project contents 📡
        uses: actions/checkout@v2
      - 
        name: Use cache (manually) 📦 # See https://github.com/freckle/stack-cache-action/issues/5
        uses: actions/cache@v2.1.3
        # TODO: Cache might be done better, see for inspiration:  https://github.com/godu/advent-of-code-2020/blob/46796832f59d185457a8edf8de043a54a451d688/.github/workflows/ci.yml
        with:
          path: | 
            ~/.ghc
            ~/.stack
            ~/.stack-work
          key: ${{ runner.os }}-stack
      - 
        name: Set up MySQL 🧰
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: '8.0'
      - 
        name: Setup PHP 🧰
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mysqli
      - 
        name: Build and test 🏗 🧪
        uses: freckle/stack-action@main
        with:
          stack-arguments: '--copy-bins --flag ampersand:buildAll'
          weeder: false
          hlint: false

